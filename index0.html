<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cesium GLB Viewer – Enhanced</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.128/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.128/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script>
    const localServer = `http://localhost:5500`; // adjust if needed

    (async () => {
      // Load base map
      const esri = await Cesium.ArcGisMapServerImageryProvider.fromUrl(
        'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
      );

      const viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: false,
        baseLayer: Cesium.ImageryLayer.fromProviderAsync(esri),
        timeline: false,
        animation: false,
        geocoder: false,
        homeButton: false,
        sceneModePicker: false,
        navigationHelpButton: false,
        baseLayerPicker: false,
        fullscreenButton: false,
      });

      // ✅ Enable lighting & shadows for better 3D feel
      viewer.scene.globe.enableLighting = true;
      viewer.shadows = true;
      viewer.scene.shadowMap.enabled = true;
      viewer.scene.shadowMap.softShadows = true;
      viewer.scene.shadowMap.size = 2048;

      // ✅ Add custom directional light
      viewer.scene.light = new Cesium.DirectionalLight({
        direction: new Cesium.Cartesian3(-1.0, -1.0, -1.0),
      });

      // ✅ Improve depth and transparency handling
      viewer.scene.globe.depthTestAgainstTerrain = true;
      viewer.scene.globe.translucency.enabled = true;
      viewer.scene.globe.translucency.frontFaceAlpha = 0.6;
      viewer.scene.globe.translucency.backFaceAlpha = 0.3;
      viewer.scene.globe.baseColor = Cesium.Color.GRAY;

      // Load model list from JSON
      const response = await fetch(`${localServer}/models.json`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const modelData = await response.json();

      // Fly to first model
      const center = Cesium.Cartesian3.fromDegrees(
        modelData[0].lon,
        modelData[0].lat,
        modelData[0].height + 1000
      );
      viewer.camera.flyTo({
        destination: center,
        duration: 2,
      });

      // Add models
      modelData.forEach((item) => {
        const position = Cesium.Cartesian3.fromDegrees(
          item.lon - 0.006,
          item.lat - 0.0005,
          item.height
        );
        const heading = Cesium.Math.toRadians(90 + item.heading);
        const hpr = new Cesium.HeadingPitchRoll(heading, 0, 0);
        const orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);

        viewer.entities.add({
          position,
          orientation,
          model: {
            uri: `${localServer}/${item.filename}`,
            minimumPixelSize: 128,
            maximumScale: 20000,
            colorBlendMode: Cesium.ColorBlendMode.HIGHLIGHT,
            colorBlendAmount: 0.3,
          },
        });
      });
    })();
  </script>
</body>

</html>
